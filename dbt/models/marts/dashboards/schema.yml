version: 2

models:
  - name: family_indicators
    description: >
      **Wide, denormalized mart for Tableau visualization with zero joins required.**

      **Grain:** Family × Indicator × Snapshot (latest snapshots only, where is_last = true)

      **Purpose:** Single source of truth for dashboard creation. All dimension attributes
      pre-joined and flattened for drag-and-drop visualization in Tableau/Superset.

      **Row Count:** Approximately 75,000 rows (one per family-indicator combination for latest surveys)

      **Key Features:**
      - ✅ No joins needed in BI tool - all attributes denormalized
      - ✅ Two-level indicator architecture: master (English) + survey (localized)
      - ✅ Latest snapshots only (current family status)
      - ✅ Includes skipped indicators (NULL values) for completeness analysis
      - ✅ Includes anonymous families (privacy-protected)

      **Tableau Usage Patterns:**

      1. **Most Red/Yellow Indicators Chart:**
         - Group by: `indicator_name` (English)
         - Measure: COUNT(CASE WHEN indicator_status_value = 1...)
         - Sort: Red count DESC

      2. **All Indicators Overview:**
         - Group by: `indicator_name`, `dimension_name`
         - Measure: COUNT by status value
         - Filter: organization_name, snapshot_year

      3. **Geographic Map:**
         - Dimensions: latitude, longitude
         - Color: indicator_status_value
         - Filter: indicator_name = specific indicator

      4. **Organizational Comparison:**
         - Group by: organization_name, application_name
         - Measure: AVG(indicator_status_value) for aggregate score
         - Filter: country_code, dimension_name

    columns:
      # ========================================================================
      # SNAPSHOT ATTRIBUTES
      # ========================================================================
      - name: snapshot_id
        description: "Unique snapshot identifier from data_collect.snapshot"
        data_tests:
          - not_null

      - name: snapshot_number
        description: "Survey round number: 1=baseline, 2=first follow-up, etc. All rows have snapshot_number >= 1 since only latest is included"
        data_tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 1"

      # ========================================================================
      # DATE ATTRIBUTES
      # ========================================================================
      - name: snapshot_date
        description: "Date when survey was completed"
        data_tests:
          - not_null

      - name: snapshot_year
        description: "Year of survey completion (e.g., 2024)"
        data_tests:
          - not_null

      - name: snapshot_quarter
        description: "Quarter of survey completion (1-4)"
        data_tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4]

      - name: snapshot_month
        description: "Month of survey completion (1-12)"
        data_tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]

      # ========================================================================
      # FAMILY ATTRIBUTES
      # ========================================================================
      - name: family_id
        description: "Natural key - unique family identifier"
        data_tests:
          - not_null

      - name: family_code
        description: "Human-readable family code (e.g., 'FAM-12345')"
        data_tests:
          - not_null

      - name: family_name
        description: "Family display name. Shows 'ANON_DATA' when is_anonymous = true"

      - name: is_anonymous
        description: "Privacy flag. When true, family_name and other personal fields are anonymized"
        data_tests:
          - not_null

      - name: latitude
        description: "GPS latitude coordinate for map visualization (-90 to 90)"
        data_tests:
          - dbt_utils.expression_is_true:
              expression: ">= -90 AND <= 90"
              config:
                where: "latitude is not null"

      - name: longitude
        description: "GPS longitude coordinate for map visualization (-180 to 180)"
        data_tests:
          - dbt_utils.expression_is_true:
              expression: ">= -180 AND <= 180"
              config:
                where: "longitude is not null"

      - name: family_country_code
        description: "Country code derived from family member birth country (e.g., 'PY', 'BR')"

      # ========================================================================
      # ORGANIZATION ATTRIBUTES
      # ========================================================================
      - name: organization_id
        description: "Natural key - organization identifier"
        data_tests:
          - not_null

      - name: organization_name
        description: "Organization display name - PRIMARY FILTER for organizational analysis"
        data_tests:
          - not_null

      - name: organization_country_code
        description: "Country code where organization operates"

      - name: application_id
        description: "Parent application/hub identifier in organizational hierarchy"
        data_tests:
          - not_null

      - name: application_name
        description: "Parent application/hub name - for regional rollups"
        data_tests:
          - not_null

      - name: application_country_code
        description: "Country code where application/hub is based"

      # ========================================================================
      # SURVEY ATTRIBUTES
      # ========================================================================
      - name: survey_definition_id
        description: "Survey template/version identifier"
        data_tests:
          - not_null

      - name: survey_title
        description: "Survey template name (e.g., 'Paraguay Baseline Survey v2')"
        data_tests:
          - not_null

      # ========================================================================
      # MASTER INDICATOR ATTRIBUTES (for aggregation)
      # ========================================================================
      - name: indicator_name
        description: >
          **PRIMARY FIELD FOR DASHBOARD GROUPING** - Canonical English indicator name (e.g., 'Income', 'Savings').
          Use this field to aggregate across all surveys regardless of language.
          Example: All "Income" indicators group together even if survey used "Ingresos" or "Renda".
        data_tests:
          - not_null

      - name: dimension_name
        description: "Poverty dimension category - one of 6 dimensions used to organize indicators"
        data_tests:
          - not_null
          - accepted_values:
              values: ['Education and Culture', 'Health and Environment', 'Housing and Infrastructure', 'Income and Employment', 'Interiority and Motivation', 'Organization and Participation']

      # ========================================================================
      # SURVEY INDICATOR ATTRIBUTES (for drill-down)
      # ========================================================================
      - name: survey_indicator_short_name
        description: >
          Localized indicator name shown to families in the survey (e.g., 'Ingresos', 'Renda', 'Income').
          Use for drill-down to see language-specific variations.

      - name: survey_indicator_question_text
        description: "Full question text as asked in the survey in local language. Use for tooltips or detail views."

      - name: survey_indicator_description
        description: "Localized aspirational description of green status. Helps explain what success looks like."

      # ========================================================================
      # MEASURE
      # ========================================================================
      - name: indicator_status_value
        description: >
          **PRIMARY MEASURE** - Stoplight poverty assessment:
          - 1 = Red (critical poverty/unmet need)
          - 2 = Yellow (moderate poverty/vulnerability)
          - 3 = Green (non-poor/need met)
          - NULL = Skipped/not applicable

          **Tableau Calculations:**
          - Red count: SUM(IF indicator_status_value = 1 THEN 1 ELSE 0 END)
          - Yellow count: SUM(IF indicator_status_value = 2 THEN 1 ELSE 0 END)
          - Green count: SUM(IF indicator_status_value = 3 THEN 1 ELSE 0 END)
          - Aggregate score: AVG(indicator_status_value) -- Range: 1.0 to 3.0
        data_tests:
          - accepted_values:
              values: [1, 2, 3]
              config:
                severity: warn
                where: "indicator_status_value is not null"

  - name: family_indicators_signal
    description: >
      **Organization-scoped dataset for Signal organization.**

      Filtered view of family_indicators containing only Signal data.
      Designed to simplify BI dashboard development by eliminating the need
      for organization filtering and reducing dataset complexity.

      **Organization Stats:**
      - Organization: Signal (hub application)
      - Families: 967 (LARGE dataset for stress testing)
      - Indicators: 55
      - Total Records: 45,358
      - Data Completeness: 100%

      **Use Case:** Pre-filtered dataset for Signal-specific dashboards and analytics.
      All columns identical to family_indicators parent model.

  - name: family_indicators_unbound_honduras
    description: >
      **Organization-scoped dataset for Unbound honduras organization.**

      Filtered view of family_indicators containing only Unbound honduras data.
      Designed to simplify BI dashboard development by eliminating the need
      for organization filtering and reducing dataset complexity.

      **Organization Stats:**
      - Organization: Unbound honduras (unbound_hon_hub application)
      - Families: 231 (MEDIUM dataset with perfect balance)
      - Indicators: 50 (ideal standard survey size)
      - Total Records: 11,550
      - Data Completeness: 100%

      **Use Case:** Pre-filtered dataset for Unbound Honduras-specific dashboards and analytics.
      All columns identical to family_indicators parent model.

  - name: family_indicators_empresas_semaforo
    description: >
      **Organization-scoped dataset for Empresas del Semáforo Paraguay.**

      Filtered view of family_indicators containing only Empresas del Semáforo Paraguay data.
      Designed to simplify BI dashboard development by eliminating the need
      for organization filtering and reducing dataset complexity.

      **Organization Stats:**
      - Organization: Empresas del Semáforo Paraguay (hub application)
      - Families: 97 (SMALL dataset for quick testing)
      - Indicators: 51 (ideal standard survey size)
      - Total Records: 4,947
      - Data Completeness: 100%

      **Use Case:** Pre-filtered dataset for Empresas del Semáforo-specific dashboards and analytics.
      All columns identical to family_indicators parent model.
