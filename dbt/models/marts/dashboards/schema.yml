version: 2

models:
  - name: mart_indicators
    description: >
      **Indicator Model for Time-Series Analysis.**

      **Grain:** One row per family × indicator × snapshot (family_id × survey_indicator_id × snapshot_id)

      **Use Case:** Time-series charts showing % Green across Baseline, 1st Follow-up, 2nd Follow-up, etc.
      Includes ALL snapshots for complete longitudinal analysis.

      **Key Features:**
      - Long structure with snapshot_type column (Baseline, 1st Follow-up, 2nd Follow-up, etc.)
      - Column names consistent with mart_assessments (snapshot_type, snapshot_sequence)
      - Canonical English indicator_name for cross-survey grouping
      - Localized indicator text for display
      - Color criteria descriptions for tooltips

      **BI Usage Patterns:**
      - Time-series % Green: Group by snapshot_type, calculate COUNT(*) FILTER (WHERE status_label = 'Green') / COUNT(*)
      - Dimension breakdown: Add dimension_name or indicator_name to grouping
      - Cohort filtering: Filter by hub_name, organization_name, survey_title
      - Use snapshot_sequence for sorting (1, 2, 3, ...) instead of snapshot_type

    columns:
      - name: family_id
        description: "Unique family identifier"
        data_tests:
          - not_null

      - name: snapshot_type
        description: "Survey type label: 'Baseline', '1st Follow-up', '2nd Follow-up', etc. (consistent with mart_assessments)"
        data_tests:
          - not_null

      - name: snapshot_sequence
        description: "Numeric sequence (1=Baseline, 2=1st Follow-up, etc.) - use for sorting"
        data_tests:
          - not_null

      - name: application_id
        description: "Application/hub ID for RLS filtering"
        data_tests:
          - not_null

      - name: hub_name
        description: "Regional/functional hub (application) name"
        data_tests:
          - not_null

      - name: organization_name
        description: "Name of the organization conducting the survey"
        data_tests:
          - not_null

      - name: project_name
        description: "Project name (nullable - not all surveys have projects)"

      - name: indicator_name
        description: >
          **PRIMARY GROUPING FIELD** - Canonical English indicator name.
          Use for aggregation across surveys regardless of language.
        data_tests:
          - not_null

      - name: dimension_name
        description: "Poverty dimension category (e.g., Housing, Health, Education)"

      - name: survey_title
        description: "Title of the survey definition"
        data_tests:
          - not_null

      - name: survey_indicator_short_name
        description: "Localized short name for display"

      - name: survey_indicator_question_text
        description: "Full localized question text"

      - name: survey_indicator_description
        description: "Localized indicator description"

      - name: red_criteria_description
        description: "Description of what constitutes Red (critical poverty) status"

      - name: yellow_criteria_description
        description: "Description of what constitutes Yellow (moderate poverty) status"

      - name: green_criteria_description
        description: "Description of what constitutes Green (non-poor) status"

      - name: status_value
        description: "Indicator status: 1=Red, 2=Yellow, 3=Green, NULL=skipped"

      - name: status_label
        description: "Human-readable label: 'Red', 'Yellow', 'Green', 'Skipped'"
        data_tests:
          - not_null

  - name: mart_surveys
    description: >
      **Aggregated Survey Summary for Dashboards.**
      
      **Grain:** One row per Snapshot.
      
      **Use Case:** High-level executive dashboard showing total surveys, priority counts, achievement counts, and stoplight status (Red/Yellow/Green) breakdown.
      optimized as a table for fast performance.
    columns:
      - name: snapshot_id
        description: "Primary key"
        data_tests:
          - unique
          - not_null
      - name: snapshot_date
        description: "Date the survey was taken"
      - name: count_red_indicators
        description: "Total number of RED indicators in this survey"
      - name: count_priorities
        description: "Total number of priorities set in this survey"
      - name: count_achievements
        description: "Total number of achievements recorded in this survey"
      - name: family_id
        description: "Foreign key to family"

  - name: mart_family_members
    description: >
      **Family Member Demographics for Dashboards.**
      
      **Grain:** One row per Family Member.
      
      **Use Case:** Analyze demographics (Gender, Country of Origin) across the beneficiary population.
    columns:
      - name: family_member_id
        description: "Primary key"
        data_tests:
          - unique
          - not_null
      - name: gender
        description: "Normalized gender (Male, Female, Other)"
      - name: birth_country
        description: "Normalized country of birth (ISO Alpha-2 code)"
      - name: family_country
        description: "Country where the family lives"

  - name: mart_families
    description: >
      **Families Dashboard - Complete Family Profile.**

      **Grain:** One row per Family.

      **Use Case:** Analyze the current status, history, and progress of families
      in the Poverty Stoplight program. Includes member demographics, survey history,
      and geographic location.

      **Key Features:**
      - Organization context from latest snapshot (handles multi-org families)
      - Member counts by gender
      - Survey frequency metrics
      - Geographic coordinates for mapping

      **BI Usage Patterns:**
      - Family counts: COUNT(family_id) grouped by organization, hub, country
      - Demographics: SUM(members_male), SUM(members_female), etc.
      - Follow-up rates: Filter surveys_taken > 1
      - Survey cadence: AVG(avg_days_between_surveys)
    columns:
      - name: family_id
        description: "Unique identifier for each family"
        data_tests:
          - unique
          - not_null

      - name: application_id
        description: "Application ID for Row Level Security (RLS) filtering"
        data_tests:
          - not_null

      - name: organization_name
        description: "The name of the organization or partner managing the family"
        data_tests:
          - not_null

      - name: hub_name
        description: "The regional or functional hub (application) the organization belongs to"
        data_tests:
          - not_null

      - name: country
        description: "The country where the family is located (ISO code from application)"
        data_tests:
          - not_null

      - name: latitude
        description: "Geographic latitude of the family location"

      - name: longitude
        description: "Geographic longitude of the family location"

      - name: baseline_date
        description: "The date the family took their very first survey"
        data_tests:
          - not_null

      - name: latest_date
        description: "The date the family took their latest survey"
        data_tests:
          - not_null

      - name: members_count
        description: "The total number of family members"
        data_tests:
          - not_null

      - name: members_male
        description: "Count of family members whose gender is Male"
        data_tests:
          - not_null

      - name: members_female
        description: "Count of family members whose gender is Female"
        data_tests:
          - not_null

      - name: members_other
        description: "Count of family members whose gender is Other"
        data_tests:
          - not_null

      - name: surveys_taken
        description: "The total number of surveys a family has completed to date"
        data_tests:
          - not_null

      - name: avg_days_between_surveys
        description: >
          Average days between surveys. Calculated as (latest_date - baseline_date) / (surveys_taken - 1).
          NULL for families with only one survey.

  - name: mart_assessments
    description: >
      **Operational Survey Tracking for Dashboards.**

      **Grain:** One row per survey submission (assessment/snapshot).

      **Use Case:** Analyze field activity, monitor survey volume by partner,
      and track the frequency of family interactions over time.

      **Key Features:**
      - Survey cadence tracking via days_since_last_survey
      - Dynamic snapshot type labels (Baseline, 1st Follow-up, etc.)
      - Full organizational hierarchy (Hub → Organization → Project)
      - RLS-enabled via application_id

      **BI Usage Patterns:**
      - Families Surveyed: COUNT DISTINCT(family_id)
      - Avg Days Since Last: AVG(days_since_last_survey) - auto-excludes NULLs
      - Survey volume trends: Group by survey_date, organization_name, hub_name
      - Baseline vs Follow-up: Filter by snapshot_type or snapshot_sequence
    columns:
      - name: snapshot_id
        description: "Primary key - unique identifier for each assessment"
        data_tests:
          - unique
          - not_null

      - name: family_id
        description: "Family receiving the assessment (for counting unique families)"
        data_tests:
          - not_null

      - name: survey_date
        description: "Date the survey was completed"
        data_tests:
          - not_null

      - name: organization_name
        description: "Organization or partner managing the survey"
        data_tests:
          - not_null

      - name: hub_name
        description: "Regional/functional hub (application) the organization belongs to"
        data_tests:
          - not_null

      - name: application_id
        description: "Application ID for Row Level Security (RLS) filtering"
        data_tests:
          - not_null

      - name: project_name
        description: "Project or funding source (nullable - not all surveys have projects)"

      - name: survey_name
        description: "Name of the survey model used"
        data_tests:
          - not_null

      - name: snapshot_type
        description: "Type of assessment: Baseline, 1st Follow-up, 2nd Follow-up, etc."
        data_tests:
          - not_null

      - name: snapshot_sequence
        description: "Numerical order of the survey for that family (1=First, 2=Second, etc.)"
        data_tests:
          - not_null

      - name: days_since_last_survey
        description: "Days elapsed since previous survey for this family (NULL for baselines)"

  - name: mart_indicator_transitions
    description: >
      **Indicator Transitions for Baseline vs Latest Comparison.**

      **Grain:** One row per family × indicator (family_id × survey_indicator_id).

      **Use Case:** Analyze which poverty indicators are improving or worsening
      across the portfolio. Compares baseline (snapshot_number = 1) to latest
      (is_last = true) survey responses at the family level.

      **Key Features:**
      - Only includes indicators present in BOTH baseline AND latest snapshots
      - Individual family-level transitions (not pre-aggregated)
      - transition_type column for easy filtering/grouping in Superset
      - Filterable by hub, organization, project, survey, and dimension
      - RLS-enabled via application_id

      **BI Usage Patterns:**
      - Transition counts: COUNT(*) WHERE transition_type = 'Red to Green'
      - Impact analysis: Group by indicator_name, transition_type
      - Family drill-down: Filter by family_id to see all indicator changes
      - Cohort analysis: Filter by hub_name, organization_name, or project_name
    columns:
      - name: family_id
        description: "Unique family identifier - part of composite key"
        data_tests:
          - not_null

      - name: application_id
        description: "Application ID for Row Level Security (RLS) filtering"
        data_tests:
          - not_null

      - name: hub_name
        description: "Regional/functional hub (application) the organization belongs to"
        data_tests:
          - not_null

      - name: organization_name
        description: "Name of the organization conducting surveys"
        data_tests:
          - not_null

      - name: project_name
        description: "Project or funding source (nullable - not all surveys have projects)"

      - name: indicator_name
        description: "Canonical English indicator name - primary grouping field"
        data_tests:
          - not_null

      - name: dimension_name
        description: "Poverty dimension category (e.g., Housing, Health, Education)"

      - name: survey_title
        description: "Title of the survey definition"
        data_tests:
          - not_null

      - name: survey_indicator_short_name
        description: "Localized short name for display"

      - name: survey_indicator_question_text
        description: "Full localized question text"

      - name: survey_indicator_description
        description: "Localized indicator description"

      - name: red_criteria_description
        description: "Description of what constitutes Red (critical poverty) status"

      - name: yellow_criteria_description
        description: "Description of what constitutes Yellow (moderate poverty) status"

      - name: green_criteria_description
        description: "Description of what constitutes Green (non-poor) status"

      - name: baseline_value
        description: "Indicator status at baseline: 1=Red, 2=Yellow, 3=Green, NULL=skipped"

      - name: baseline_label
        description: "Human-readable label for baseline status: 'Red', 'Yellow', 'Green', 'Skipped'"
        data_tests:
          - not_null

      - name: latest_value
        description: "Indicator status at latest survey: 1=Red, 2=Yellow, 3=Green, NULL=skipped"

      - name: latest_label
        description: "Human-readable label for latest status: 'Red', 'Yellow', 'Green', 'Skipped'"
        data_tests:
          - not_null

      - name: transition_type
        description: >
          Computed transition category for easy filtering:
          'Red to Green', 'Red to Yellow', 'Yellow to Green' (improvements),
          'Green to Red', 'Green to Yellow', 'Yellow to Red' (declines),
          'No Change', or 'Other' (involves skipped values)
        data_tests:
          - not_null
