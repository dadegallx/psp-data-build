version: 2

models:
  - name: family_indicators
    description: >
      **Simplified, business-user-friendly dashboard for poverty indicator analysis.**

      **Grain:** Family × Indicator × Snapshot (latest snapshots only)

      **Columns:** 20 total
      - 4 date columns
      - 2 family identifiers
      - 2 organization context
      - 8 indicator definition (including color criteria)
      - 4 poverty status flags (integer 0/1)

      **Key Features:**
      - ✅ Laser-focused on indicators - removed technical/privacy fields
      - ✅ Integer flags for easy counting: is_red, is_yellow, is_green, is_skipped (1/0)
      - ✅ Simple aggregation: SUM(is_red), AVG(is_green) * 100 - no casting needed!
      - ✅ Two-level indicator architecture: master (English) + survey (localized)
      - ✅ Latest snapshots only (current family status)

      **Superset/Tableau Usage Patterns:**

      1. **Most Critical Indicators (Top Red Count):**
         - Group by: `indicator_name`
         - Metric: `SUM(is_red)` or `COUNT(*) FILTER (WHERE is_red = 1)`
         - Sort: Red count DESC
         - Chart: Horizontal bar chart

      2. **Poverty Distribution by Dimension:**
         - Group by: `dimension_name`
         - Metrics:
           * Red: `SUM(is_red)`
           * Yellow: `SUM(is_yellow)`
           * Green: `SUM(is_green)`
         - Chart: Stacked bar chart or pie chart

      3. **Progress Over Time:**
         - X-axis: `snapshot_year` and `snapshot_quarter`
         - Metrics:
           * Green %: `AVG(is_green) * 100`
           * Red %: `AVG(is_red) * 100`
         - Chart: Line chart or area chart

      4. **Organization Comparison:**
         - Group by: `organization_name`
         - Metrics:
           * Total families: `COUNT(DISTINCT family_id)`
           * Red %: `AVG(is_red) * 100`
           * Green %: `AVG(is_green) * 100`
         - Chart: Table or grouped bar chart

      5. **Indicator Detail Drill-Down:**
         - Filter: `indicator_name` = specific indicator
         - Group by: `survey_indicator_short_name` (localized name)
         - Show: `survey_indicator_question_text` for full context
         - Metrics: Red/Yellow/Green counts

    columns:
      # ========================================================================
      # DATE ATTRIBUTES (4 columns)
      # ========================================================================
      - name: snapshot_date
        description: "Date when survey was completed"
        data_tests:
          - not_null

      - name: snapshot_year
        description: "Year of survey completion (e.g., 2024)"
        data_tests:
          - not_null

      - name: snapshot_quarter
        description: "Quarter of survey completion (1-4)"
        data_tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4]

      - name: snapshot_month
        description: "Month of survey completion (1-12)"
        data_tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]

      # ========================================================================
      # FAMILY IDENTIFIERS (2 columns)
      # ========================================================================
      - name: family_id
        description: "Unique family identifier - use for counting distinct families"
        data_tests:
          - not_null

      - name: family_code
        description: "Human-readable family code (e.g., 'FAM-12345')"
        data_tests:
          - not_null

      # ========================================================================
      # ORGANIZATION CONTEXT (2 columns)
      # ========================================================================
      - name: organization_name
        description: "Organization display name - PRIMARY FILTER for organizational analysis"
        data_tests:
          - not_null

      - name: application_name
        description: "Parent application/hub name - for regional rollups and multi-org analysis"
        data_tests:
          - not_null

      # ========================================================================
      # INDICATOR DEFINITION (8 columns)
      # ========================================================================
      - name: indicator_name
        description: >
          **PRIMARY FIELD FOR DASHBOARD GROUPING** - Canonical English indicator name (e.g., 'Income', 'Savings').
          Use this field to aggregate across all surveys regardless of language.
          Example: All "Income" indicators group together even if survey used "Ingresos" or "Renda".
        data_tests:
          - not_null

      - name: dimension_name
        description: "Poverty dimension category - one of 6 dimensions used to organize indicators"
        data_tests:
          - not_null
          - accepted_values:
              values: ['Education and Culture', 'Health and Environment', 'Housing and Infrastructure', 'Income and Employment', 'Interiority and Motivation', 'Organization and Participation']

      - name: survey_indicator_short_name
        description: >
          Localized indicator name shown to families in the survey (e.g., 'Ingresos', 'Renda', 'Income').
          Use for drill-down to see language-specific variations.

      - name: survey_indicator_question_text
        description: "Full question text as asked in the survey in local language. Use for tooltips or detail views."

      - name: survey_indicator_description
        description: "Localized aspirational description of green status. Helps explain what success looks like."

      - name: red_criteria_description
        description: >
          Description of critical poverty threshold for this indicator (value=1).
          Explains what conditions qualify as "red" status.
          **Use in dashboards:** Tooltip text, drill-down details, explanation cards

      - name: yellow_criteria_description
        description: >
          Description of moderate poverty threshold for this indicator (value=2).
          Explains what conditions qualify as "yellow" status.
          **Use in dashboards:** Tooltip text, drill-down details, explanation cards

      - name: green_criteria_description
        description: >
          Description of non-poor threshold for this indicator (value=3).
          Explains what conditions qualify as "green" status.
          **Use in dashboards:** Tooltip text, drill-down details, explanation cards

      # ========================================================================
      # POVERTY STATUS FLAGS (4 columns) - Integer 0/1 for easy counting/averaging
      # ========================================================================
      - name: is_red
        description: >
          **CRITICAL POVERTY FLAG** - Integer (1 when indicator shows critical poverty/unmet need, 0 otherwise).

          **Business User Calculations (no casting needed!):**
          - Count red indicators: `SUM(is_red)` or `COUNT(*) FILTER (WHERE is_red = 1)`
          - Red percentage: `AVG(is_red) * 100`
          - Filter to reds only: `WHERE is_red = 1`
        data_tests:
          - not_null
          - accepted_values:
              values: [0, 1]

      - name: is_yellow
        description: >
          **MODERATE POVERTY FLAG** - Integer (1 when indicator shows moderate poverty/vulnerability, 0 otherwise).

          **Business User Calculations (no casting needed!):**
          - Count yellow indicators: `SUM(is_yellow)` or `COUNT(*) FILTER (WHERE is_yellow = 1)`
          - Yellow percentage: `AVG(is_yellow) * 100`
          - Filter to yellows only: `WHERE is_yellow = 1`
        data_tests:
          - not_null
          - accepted_values:
              values: [0, 1]

      - name: is_green
        description: >
          **SUCCESS FLAG** - Integer (1 when indicator shows non-poor/need met, 0 otherwise).

          **Business User Calculations (no casting needed!):**
          - Count green indicators: `SUM(is_green)` or `COUNT(*) FILTER (WHERE is_green = 1)`
          - Green percentage (success rate): `AVG(is_green) * 100`
          - Filter to greens only: `WHERE is_green = 1`
          - Track progress: Compare green % over time
        data_tests:
          - not_null
          - accepted_values:
              values: [0, 1]

      - name: is_skipped
        description: >
          **SKIPPED/NOT APPLICABLE FLAG** - Integer (1 when indicator was not assessed, 0 otherwise).

          **Business User Calculations (no casting needed!):**
          - Count skipped indicators: `SUM(is_skipped)` or `COUNT(*) FILTER (WHERE is_skipped = 1)`
          - Skipped percentage: `AVG(is_skipped) * 100`
          - Data completeness: `100 - AVG(is_skipped) * 100`
        data_tests:
          - not_null
          - accepted_values:
              values: [0, 1]

  - name: family_indicators_signal
    description: >
      **Organization-scoped dataset for Signal organization.**

      Filtered view of family_indicators containing only Signal data.
      Designed to simplify BI dashboard development by eliminating the need
      for organization filtering and reducing dataset complexity.

      **Organization Stats:**
      - Organization: Signal (hub application)
      - Families: 967 (LARGE dataset for stress testing)
      - Indicators: 55
      - Total Records: 45,358
      - Data Completeness: 100%

      **Use Case:** Pre-filtered dataset for Signal-specific dashboards and analytics.
      All columns identical to family_indicators parent model.

  - name: family_indicators_unbound_honduras
    description: >
      **Organization-scoped dataset for Unbound honduras organization.**

      Filtered view of family_indicators containing only Unbound honduras data.
      Designed to simplify BI dashboard development by eliminating the need
      for organization filtering and reducing dataset complexity.

      **Organization Stats:**
      - Organization: Unbound honduras (unbound_hon_hub application)
      - Families: 231 (MEDIUM dataset with perfect balance)
      - Indicators: 50 (ideal standard survey size)
      - Total Records: 11,550
      - Data Completeness: 100%

      **Use Case:** Pre-filtered dataset for Unbound Honduras-specific dashboards and analytics.
      All columns identical to family_indicators parent model.

  - name: family_indicators_empresas_semaforo
    description: >
      **Organization-scoped dataset for Empresas del Semáforo Paraguay.**

      Filtered view of family_indicators containing only Empresas del Semáforo Paraguay data.
      Designed to simplify BI dashboard development by eliminating the need
      for organization filtering and reducing dataset complexity.

      **Organization Stats:**
      - Organization: Empresas del Semáforo Paraguay (hub application)
      - Families: 97 (SMALL dataset for quick testing)
      - Indicators: 51 (ideal standard survey size)
      - Total Records: 4,947
      - Data Completeness: 100%

      **Use Case:** Pre-filtered dataset for Empresas del Semáforo-specific dashboards and analytics.
      All columns identical to family_indicators parent model.
