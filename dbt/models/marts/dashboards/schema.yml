version: 2

models:
  - name: mart_indicators
    description: >
      **Pivoted indicator model for baseline vs follow-up comparison.**

      **Grain:** One row per family per survey_indicator

      **Use Case:** Compare family progress from baseline to follow-up surveys.
      Enables side-by-side analysis of indicator changes over time.

      **Key Features:**
      - Pivoted structure with baseline, first follow-up, and latest follow-up columns
      - Delta columns showing improvement/decline between snapshots
      - Canonical English indicator_name for cross-survey grouping
      - Localized indicator text for display
      - Color criteria descriptions for tooltips

      **BI Usage Patterns:**
      - Improvement analysis: Filter has_followup_data = true, analyze baseline_to_latest_diff
      - Cohort comparison: Group by total_snapshots to segment by follow-up depth
      - Indicator trends: Compare baseline_value vs latest_followup_value distributions
      - Time filtering: Use baseline_date, first_followup_date, latest_followup_date

    columns:
      - name: family_id
        description: "Unique family identifier"
        data_tests:
          - not_null

      - name: application_id
        description: "Application/hub ID for RLS filtering"
        data_tests:
          - not_null

      - name: organization_name
        description: "Name of the organization conducting the survey"

      - name: application_name
        description: "Parent application/hub name"

      - name: survey_title
        description: "Title of the survey definition"

      - name: project_name
        description: "Project name (from baseline snapshot, nullable)"

      - name: indicator_name
        description: >
          **PRIMARY GROUPING FIELD** - Canonical English indicator name.
          Use for aggregation across surveys regardless of language.

      - name: dimension_name
        description: "Poverty dimension category (e.g., Housing, Health, Education)"

      - name: survey_indicator_short_name
        description: "Localized short name for display"

      - name: survey_indicator_question_text
        description: "Full localized question text"

      - name: survey_indicator_description
        description: "Localized indicator description"

      - name: red_criteria_description
        description: "Description of what constitutes Red (critical poverty) status"

      - name: yellow_criteria_description
        description: "Description of what constitutes Yellow (moderate poverty) status"

      - name: green_criteria_description
        description: "Description of what constitutes Green (non-poor) status"

      - name: total_snapshots
        description: "Total number of snapshots for this family × indicator (1 = baseline only, 2+ = has follow-ups)"
        data_tests:
          - not_null

      - name: baseline_date
        description: "Date of baseline survey (snapshot_number = 1). NULL if indicator was added in follow-up."

      - name: baseline_value
        description: "Indicator status at baseline: 1=Red, 2=Yellow, 3=Green, NULL=skipped or no baseline"

      - name: baseline_label
        description: "Human-readable label for baseline status: 'Red', 'Yellow', 'Green', 'Skipped', or NULL"

      - name: first_followup_date
        description: "Date of first follow-up survey (snapshot_number = 2). NULL if no follow-up."

      - name: first_followup_value
        description: "Indicator status at first follow-up: 1=Red, 2=Yellow, 3=Green, NULL=skipped or no follow-up"

      - name: first_followup_label
        description: "Human-readable label for first follow-up status"

      - name: latest_followup_date
        description: "Date of most recent follow-up survey. NULL if no follow-up."

      - name: latest_followup_value
        description: "Indicator status at latest follow-up: 1=Red, 2=Yellow, 3=Green, NULL=skipped or no follow-up"

      - name: latest_followup_label
        description: "Human-readable label for latest follow-up status"

      - name: baseline_to_first_diff
        description: >
          Change from baseline to first follow-up (first_followup_value - baseline_value).
          Positive = improvement, Negative = decline, NULL = missing data.

      - name: baseline_to_latest_diff
        description: >
          Change from baseline to latest follow-up (latest_followup_value - baseline_value).
          Positive = improvement, Negative = decline, NULL = missing data.

      - name: has_followup_data
        description: "True if family has at least one follow-up survey (first_followup_value is not null)"
        data_tests:
          - not_null

  - name: mart_surveys
    description: >
      **Aggregated Survey Summary for Dashboards.**
      
      **Grain:** One row per Snapshot.
      
      **Use Case:** High-level executive dashboard showing total surveys, priority counts, achievement counts, and stoplight status (Red/Yellow/Green) breakdown.
      optimized as a table for fast performance.
    columns:
      - name: snapshot_id
        description: "Primary key"
        data_tests:
          - unique
          - not_null
      - name: snapshot_date
        description: "Date the survey was taken"
      - name: count_red_indicators
        description: "Total number of RED indicators in this survey"
      - name: count_priorities
        description: "Total number of priorities set in this survey"
      - name: count_achievements
        description: "Total number of achievements recorded in this survey"
      - name: family_id
        description: "Foreign key to family"

  - name: mart_family_members
    description: >
      **Family Member Demographics for Dashboards.**
      
      **Grain:** One row per Family Member.
      
      **Use Case:** Analyze demographics (Gender, Country of Origin) across the beneficiary population.
    columns:
      - name: family_member_id
        description: "Primary key"
        data_tests:
          - unique
          - not_null
      - name: gender
        description: "Normalized gender (Male, Female, Other)"
      - name: birth_country
        description: "Normalized country of birth (ISO Alpha-2 code)"
      - name: family_country
        description: "Country where the family lives"

  - name: mart_families
    description: >
      **Family Locations and Context for Dashboards.**
      
      **Grain:** One row per Family.
      
      **Use Case:** Geospatial analysis (Maps) and Organization-level filtering.
    columns:
      - name: family_id
        description: "Primary key"
        data_tests:
          - unique
          - not_null
      - name: latitude
        description: "GPS Latitude"
      - name: longitude
        description: "GPS Longitude"
      - name: organization_name
        description: "Name of the implementing organization"

  - name: mart_assessments
    description: >
      **Operational Survey Tracking for Dashboards.**

      **Grain:** One row per survey submission (assessment/snapshot).

      **Use Case:** Analyze field activity, monitor survey volume by partner,
      and track the frequency of family interactions over time.

      **Key Features:**
      - Survey cadence tracking via days_since_last_survey
      - Dynamic snapshot type labels (Baseline, 1st Follow-up, etc.)
      - Full organizational hierarchy (Hub → Organization → Project)
      - RLS-enabled via application_id

      **BI Usage Patterns:**
      - Families Surveyed: COUNT DISTINCT(family_id)
      - Avg Days Since Last: AVG(days_since_last_survey) - auto-excludes NULLs
      - Survey volume trends: Group by survey_date, organization_name, hub_name
      - Baseline vs Follow-up: Filter by snapshot_type or snapshot_sequence
    columns:
      - name: snapshot_id
        description: "Primary key - unique identifier for each assessment"
        data_tests:
          - unique
          - not_null

      - name: family_id
        description: "Family receiving the assessment (for counting unique families)"
        data_tests:
          - not_null

      - name: survey_date
        description: "Date the survey was completed"
        data_tests:
          - not_null

      - name: organization_name
        description: "Organization or partner managing the survey"
        data_tests:
          - not_null

      - name: hub_name
        description: "Regional/functional hub (application) the organization belongs to"
        data_tests:
          - not_null

      - name: application_id
        description: "Application ID for Row Level Security (RLS) filtering"
        data_tests:
          - not_null

      - name: project_name
        description: "Project or funding source (nullable - not all surveys have projects)"

      - name: survey_name
        description: "Name of the survey model used"
        data_tests:
          - not_null

      - name: snapshot_type
        description: "Type of assessment: Baseline, 1st Follow-up, 2nd Follow-up, etc."
        data_tests:
          - not_null

      - name: snapshot_sequence
        description: "Numerical order of the survey for that family (1=First, 2=Second, etc.)"
        data_tests:
          - not_null

      - name: days_since_last_survey
        description: "Days elapsed since previous survey for this family (NULL for baselines)"
