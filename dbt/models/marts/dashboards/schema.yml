version: 2

models:
  - name: mart_indicators
    description: >
      **Pivoted indicator model for baseline vs follow-up comparison.**

      **Grain:** One row per family per survey_indicator

      **Use Case:** Compare family progress from baseline to follow-up surveys.
      Enables side-by-side analysis of indicator changes over time.

      **Key Features:**
      - Pivoted structure with baseline, first follow-up, and latest follow-up columns
      - Delta columns showing improvement/decline between snapshots
      - Canonical English indicator_name for cross-survey grouping
      - Localized indicator text for display
      - Color criteria descriptions for tooltips

      **BI Usage Patterns:**
      - Improvement analysis: Filter has_followup_data = true, analyze baseline_to_latest_diff
      - Cohort comparison: Group by total_snapshots to segment by follow-up depth
      - Indicator trends: Compare baseline_value vs latest_followup_value distributions
      - Time filtering: Use baseline_date, first_followup_date, latest_followup_date

    columns:
      - name: family_id
        description: "Unique family identifier"
        data_tests:
          - not_null

      - name: application_id
        description: "Application/hub ID for RLS filtering"
        data_tests:
          - not_null

      - name: organization_name
        description: "Name of the organization conducting the survey"

      - name: application_name
        description: "Parent application/hub name"

      - name: survey_title
        description: "Title of the survey definition"

      - name: project_name
        description: "Project name (from baseline snapshot, nullable)"

      - name: indicator_name
        description: >
          **PRIMARY GROUPING FIELD** - Canonical English indicator name.
          Use for aggregation across surveys regardless of language.

      - name: dimension_name
        description: "Poverty dimension category (e.g., Housing, Health, Education)"

      - name: survey_indicator_short_name
        description: "Localized short name for display"

      - name: survey_indicator_question_text
        description: "Full localized question text"

      - name: survey_indicator_description
        description: "Localized indicator description"

      - name: red_criteria_description
        description: "Description of what constitutes Red (critical poverty) status"

      - name: yellow_criteria_description
        description: "Description of what constitutes Yellow (moderate poverty) status"

      - name: green_criteria_description
        description: "Description of what constitutes Green (non-poor) status"

      - name: total_snapshots
        description: "Total number of snapshots for this family × indicator (1 = baseline only, 2+ = has follow-ups)"
        data_tests:
          - not_null

      - name: baseline_date
        description: "Date of baseline survey (snapshot_number = 1). NULL if indicator was added in follow-up."

      - name: baseline_value
        description: "Indicator status at baseline: 1=Red, 2=Yellow, 3=Green, NULL=skipped or no baseline"

      - name: baseline_label
        description: "Human-readable label for baseline status: 'Red', 'Yellow', 'Green', 'Skipped', or NULL"

      - name: first_followup_date
        description: "Date of first follow-up survey (snapshot_number = 2). NULL if no follow-up."

      - name: first_followup_value
        description: "Indicator status at first follow-up: 1=Red, 2=Yellow, 3=Green, NULL=skipped or no follow-up"

      - name: first_followup_label
        description: "Human-readable label for first follow-up status"

      - name: latest_followup_date
        description: "Date of most recent follow-up survey. NULL if no follow-up."

      - name: latest_followup_value
        description: "Indicator status at latest follow-up: 1=Red, 2=Yellow, 3=Green, NULL=skipped or no follow-up"

      - name: latest_followup_label
        description: "Human-readable label for latest follow-up status"

      - name: baseline_to_first_diff
        description: >
          Change from baseline to first follow-up (first_followup_value - baseline_value).
          Positive = improvement, Negative = decline, NULL = missing data.

      - name: baseline_to_latest_diff
        description: >
          Change from baseline to latest follow-up (latest_followup_value - baseline_value).
          Positive = improvement, Negative = decline, NULL = missing data.

      - name: has_followup_data
        description: "True if family has at least one follow-up survey (first_followup_value is not null)"
        data_tests:
          - not_null

  - name: mart_surveys
    description: >
      **Aggregated Survey Summary for Dashboards.**
      
      **Grain:** One row per Snapshot.
      
      **Use Case:** High-level executive dashboard showing total surveys, priority counts, achievement counts, and stoplight status (Red/Yellow/Green) breakdown.
      optimized as a table for fast performance.
    columns:
      - name: snapshot_id
        description: "Primary key"
        data_tests:
          - unique
          - not_null
      - name: snapshot_date
        description: "Date the survey was taken"
      - name: count_red_indicators
        description: "Total number of RED indicators in this survey"
      - name: count_priorities
        description: "Total number of priorities set in this survey"
      - name: count_achievements
        description: "Total number of achievements recorded in this survey"
      - name: family_id
        description: "Foreign key to family"

  - name: mart_family_members
    description: >
      **Family Member Demographics for Dashboards.**
      
      **Grain:** One row per Family Member.
      
      **Use Case:** Analyze demographics (Gender, Country of Origin) across the beneficiary population.
    columns:
      - name: family_member_id
        description: "Primary key"
        data_tests:
          - unique
          - not_null
      - name: gender
        description: "Normalized gender (Male, Female, Other)"
      - name: birth_country
        description: "Normalized country of birth (ISO Alpha-2 code)"
      - name: family_country
        description: "Country where the family lives"

  - name: mart_families
    description: >
      **Families Dashboard - Complete Family Profile.**

      **Grain:** One row per Family.

      **Use Case:** Analyze the current status, history, and progress of families
      in the Poverty Stoplight program. Includes member demographics, survey history,
      and geographic location.

      **Key Features:**
      - Organization context from latest snapshot (handles multi-org families)
      - Member counts by gender
      - Survey frequency metrics
      - Geographic coordinates for mapping

      **BI Usage Patterns:**
      - Family counts: COUNT(family_id) grouped by organization, hub, country
      - Demographics: SUM(members_male), SUM(members_female), etc.
      - Follow-up rates: Filter surveys_taken > 1
      - Survey cadence: AVG(avg_days_between_surveys)
    columns:
      - name: family_id
        description: "Unique identifier for each family"
        data_tests:
          - unique
          - not_null

      - name: application_id
        description: "Application ID for Row Level Security (RLS) filtering"
        data_tests:
          - not_null

      - name: organization_name
        description: "The name of the organization or partner managing the family"
        data_tests:
          - not_null

      - name: hub_name
        description: "The regional or functional hub (application) the organization belongs to"
        data_tests:
          - not_null

      - name: country
        description: "The country where the family is located (ISO code from application)"
        data_tests:
          - not_null

      - name: latitude
        description: "Geographic latitude of the family location"

      - name: longitude
        description: "Geographic longitude of the family location"

      - name: baseline_date
        description: "The date the family took their very first survey"
        data_tests:
          - not_null

      - name: latest_date
        description: "The date the family took their latest survey"
        data_tests:
          - not_null

      - name: members_count
        description: "The total number of family members"
        data_tests:
          - not_null

      - name: members_male
        description: "Count of family members whose gender is Male"
        data_tests:
          - not_null

      - name: members_female
        description: "Count of family members whose gender is Female"
        data_tests:
          - not_null

      - name: members_other
        description: "Count of family members whose gender is Other"
        data_tests:
          - not_null

      - name: surveys_taken
        description: "The total number of surveys a family has completed to date"
        data_tests:
          - not_null

      - name: avg_days_between_surveys
        description: >
          Average days between surveys. Calculated as (latest_date - baseline_date) / (surveys_taken - 1).
          NULL for families with only one survey.

  - name: mart_assessments
    description: >
      **Operational Survey Tracking for Dashboards.**

      **Grain:** One row per survey submission (assessment/snapshot).

      **Use Case:** Analyze field activity, monitor survey volume by partner,
      and track the frequency of family interactions over time.

      **Key Features:**
      - Survey cadence tracking via days_since_last_survey
      - Dynamic snapshot type labels (Baseline, 1st Follow-up, etc.)
      - Full organizational hierarchy (Hub → Organization → Project)
      - RLS-enabled via application_id

      **BI Usage Patterns:**
      - Families Surveyed: COUNT DISTINCT(family_id)
      - Avg Days Since Last: AVG(days_since_last_survey) - auto-excludes NULLs
      - Survey volume trends: Group by survey_date, organization_name, hub_name
      - Baseline vs Follow-up: Filter by snapshot_type or snapshot_sequence
    columns:
      - name: snapshot_id
        description: "Primary key - unique identifier for each assessment"
        data_tests:
          - unique
          - not_null

      - name: family_id
        description: "Family receiving the assessment (for counting unique families)"
        data_tests:
          - not_null

      - name: survey_date
        description: "Date the survey was completed"
        data_tests:
          - not_null

      - name: organization_name
        description: "Organization or partner managing the survey"
        data_tests:
          - not_null

      - name: hub_name
        description: "Regional/functional hub (application) the organization belongs to"
        data_tests:
          - not_null

      - name: application_id
        description: "Application ID for Row Level Security (RLS) filtering"
        data_tests:
          - not_null

      - name: project_name
        description: "Project or funding source (nullable - not all surveys have projects)"

      - name: survey_name
        description: "Name of the survey model used"
        data_tests:
          - not_null

      - name: snapshot_type
        description: "Type of assessment: Baseline, 1st Follow-up, 2nd Follow-up, etc."
        data_tests:
          - not_null

      - name: snapshot_sequence
        description: "Numerical order of the survey for that family (1=First, 2=Second, etc.)"
        data_tests:
          - not_null

      - name: days_since_last_survey
        description: "Days elapsed since previous survey for this family (NULL for baselines)"

  - name: mart_indicator_transitions
    description: >
      **Aggregated Indicator Transitions for Baseline vs Latest Comparison.**

      **Grain:** One row per indicator_name × survey_definition_id × organization × project.

      **Use Case:** Analyze which poverty indicators are improving or worsening
      across the portfolio. Compares baseline (snapshot_number = 1) to latest
      (is_last = true) survey responses.

      **Key Features:**
      - Only includes indicators present in BOTH baseline AND latest snapshots
      - Pre-aggregated counts for fast dashboard performance
      - Transition metrics showing movement between poverty levels
      - Filterable by hub, organization, project, survey, and dimension
      - RLS-enabled via application_id

      **BI Usage Patterns:**
      - Impact analysis: Sum improved_* columns vs worsened_* columns
      - Problem indicators: Sort by baseline_red_count DESC
      - Progress tracking: Compare baseline_green_count to latest_green_count
      - Drill-down: Filter by dimension_name or indicator_name
    columns:
      - name: application_id
        description: "Application ID for Row Level Security (RLS) filtering"
        data_tests:
          - not_null

      - name: hub_name
        description: "Regional/functional hub (application) the organization belongs to"
        data_tests:
          - not_null

      - name: organization_name
        description: "Name of the organization conducting surveys"
        data_tests:
          - not_null

      - name: project_name
        description: "Project or funding source (nullable - not all surveys have projects)"

      - name: indicator_name
        description: "Canonical English indicator name - primary grouping field"
        data_tests:
          - not_null

      - name: dimension_name
        description: "Poverty dimension category (e.g., Housing, Health, Education)"

      - name: survey_title
        description: "Title of the survey definition"
        data_tests:
          - not_null

      - name: survey_indicator_short_name
        description: "Localized short name for display"

      - name: survey_indicator_question_text
        description: "Full localized question text"

      - name: survey_indicator_description
        description: "Localized indicator description"

      - name: red_criteria_description
        description: "Description of what constitutes Red (critical poverty) status"

      - name: yellow_criteria_description
        description: "Description of what constitutes Yellow (moderate poverty) status"

      - name: green_criteria_description
        description: "Description of what constitutes Green (non-poor) status"

      - name: baseline_valid_responses
        description: "Count of families with valid baseline response (Red, Yellow, or Green)"
        data_tests:
          - not_null

      - name: baseline_skipped
        description: "Count of families who skipped this indicator at baseline"
        data_tests:
          - not_null

      - name: baseline_green_count
        description: "Count of families marked Green at baseline"
        data_tests:
          - not_null

      - name: baseline_yellow_count
        description: "Count of families marked Yellow at baseline"
        data_tests:
          - not_null

      - name: baseline_red_count
        description: "Count of families marked Red at baseline"
        data_tests:
          - not_null

      - name: latest_valid_responses
        description: "Count of families with valid latest response (Red, Yellow, or Green)"
        data_tests:
          - not_null

      - name: latest_skipped
        description: "Count of families who skipped this indicator in latest survey"
        data_tests:
          - not_null

      - name: latest_green_count
        description: "Count of families marked Green in latest survey"
        data_tests:
          - not_null

      - name: latest_yellow_count
        description: "Count of families marked Yellow in latest survey"
        data_tests:
          - not_null

      - name: latest_red_count
        description: "Count of families marked Red in latest survey"
        data_tests:
          - not_null

      - name: improved_red_to_green
        description: "Count of families that moved from Red (baseline) to Green (latest)"
        data_tests:
          - not_null

      - name: improved_red_to_yellow
        description: "Count of families that moved from Red (baseline) to Yellow (latest)"
        data_tests:
          - not_null

      - name: improved_yellow_to_green
        description: "Count of families that moved from Yellow (baseline) to Green (latest)"
        data_tests:
          - not_null

      - name: worsened_green_to_red
        description: "Count of families that moved from Green (baseline) to Red (latest)"
        data_tests:
          - not_null

      - name: worsened_green_to_yellow
        description: "Count of families that moved from Green (baseline) to Yellow (latest)"
        data_tests:
          - not_null

      - name: worsened_yellow_to_red
        description: "Count of families that moved from Yellow (baseline) to Red (latest)"
        data_tests:
          - not_null
