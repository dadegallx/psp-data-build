version: 2

models:
  - name: int_snapshots
    description: >
      Enriched snapshot records with recomputed survey sequencing.

      Fixes source data integrity issues by recalculating snapshot_number and is_last
      using window functions based on actual chronological order.
    columns:
      - name: snapshot_id
        description: "Primary key"
        data_tests:
          - unique
          - not_null
      - name: family_id
        description: "Foreign key to families"
        data_tests:
          - not_null
      - name: organization_id
        description: "Foreign key to organizations"
        data_tests:
          - not_null
      - name: application_id
        description: "Foreign key to applications"
      - name: survey_definition_id
        description: "Foreign key to survey definitions"
      - name: project_id
        description: "Foreign key to projects (nullable)"
      - name: is_anonymous
        description: "Privacy flag - when true, personal data is anonymized"
      - name: stoplight_skipped
        description: "Whether the stoplight section was skipped"
      - name: snapshot_date
        description: "Date when survey was completed"
      - name: snapshot_created_at
        description: "Record creation timestamp"
      - name: created_by
        description: "User who created the snapshot"
      - name: snapshot_updated_at
        description: "Record last modified timestamp"
      - name: snapshot_number
        description: >
          Recomputed survey round per family+survey_definition.
          1=baseline, >1=follow-up. Calculated chronologically to fix source data issues.
        data_tests:
          - not_null
      - name: is_last
        description: >
          Dynamically computed flag for most recent snapshot per family (across all surveys).
          Fixes source data integrity issues.
        data_tests:
          - not_null
      - name: is_baseline
        description: "True when snapshot_number = 1 (first survey in family+survey journey)"
        data_tests:
          - not_null
      - name: days_since_baseline
        description: "Days elapsed since baseline survey (0 for baseline, positive for follow-ups)"
        data_tests:
          - not_null
      - name: days_since_previous
        description: "Days elapsed since previous snapshot (NULL for baseline)"
      - name: max_snapshot_number
        description: "Max snapshot number in this family+survey journey (for cohort filtering)"
        data_tests:
          - not_null
